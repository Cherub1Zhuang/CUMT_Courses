# UDP

[无连接运输：UDP](#无连接运输：UDP)

[UDP的报文结构](#UDP的报文结构)

## 无连接运输：UDP

现在你也许想知道，为什么应用开发人员宁愿在UDP之上构建应用，而不选择在TCP 上构建应用？既然TCP提供了可靠数据传输服务，而UDP不能提供，那么TCP是否总是首选的呢？答案是否定的，因为有许多应用更适合用UDP,原因主要以下几点： 

* `关于发送什么数据以及何时发送的应用层控制更为精细`。采用UDP时，只要应用进程将数据传递给UDP,  UDP就会将此数据打包进UDP报文段并立即将其传递给网络层。在另一方面，TCP有一个拥塞控制机制，以便当源和目的主机间的一条或多条链路变得极度拥塞时来遏制运输层TCP发送方。TCP仍将继续重新发送数据报文段直到目的主机收到此报文并加以确认，而不管可靠交付需要用多长时间。 因为实时应用通常要求最小的发送速率，不希望过分地延迟报文段的传送，且能容忍一些数据丢失，TCP服务模型并不是特别适合这些应用的需要。

* `无须连接建立`。如我们后面所讨论的，TCP在开始数据传输之前要经过三次握手。 UDP却不需要任何准备即可进行数据传输。因此UDP不会引入建立连接的时延。 这可能是DNS运行在UDP之上而不是运行在TCP之上的主要原因（如果运行在 TCP上，则DNS会慢得多）。HTTP使用TCP而不是UDP,因为对于具有文本数据 的Web网页来说，可靠性是至关重要的。但是, HTTP中的TCP连接建立时延对于与下载Web文档相关的时延来说是一个重要因素。

* `无连接状态`。TCP需要在端系统中维护连接状态。此连接状态包括接收和发送缓存、 拥塞控制参数以及序号与确认号的参数。要实现TCP的可靠数据传输服务并提供拥塞控制，这些状态信息是必要的。另一方面，UDP不维护连接状态，也不跟踪这些参数。因此，某些专门用于某种特定应用的服务器当应用程序运行在UDP之上而不是运行在TCP上时，一般都能支持更多的活跃客户。 

* `分组首部开销小`。每个TCP报文段都有20字节的首部开销，而UDP仅有8字节 的开销。 



无论如何，有很多重要的应用是运行在UDP上而不是TCP上。例如 UDP用于承载网络管理数据（SNMP）。在这种场合下，UDP要优于TCP, 因为网络管理应用程序通常必须在该网络处于**重压状态时运行**，而正是在这个时候可靠的、拥塞受控的数据传输难以实现。此外，**DNS运行在UDP之上, 从而避免了 TCP的连接创建时延。** 

UDP和TCP现在都用于多媒体应用，如因特网电话、实时视频会议、 流式存储音频与视频。我们刚说过，既然所有这些应用都能容忍少量的分组丢失，因此可靠数据传输对于这些应用的成功并不是至关重要的。此外，TCP的拥塞控制会导致如因特网电话、视频会议之类的实时应用性能变得很差。由于这些原因，多媒体应用开发人员通常将这些应用运行在UDP之上而不是TCP之上

![image-20201211223624380](https://zouyishan.oss-cn-beijing.aliyuncs.com/images/20201211223626.png)

同时UDP 中缺乏拥塞控制能够导致UDP发送方和接收方之间的高丢包率，并挤垮了TCP会话，这是一个潜在的严重问题。



## UDP的报文结构

UDP结构如图所示：

![68747470733a2f2f7a6f7579697368616e2e6f73732d636e2d6265696a696e672e616c6979756e63732e636f6d2f696d616765732f32303230313231313232333734382e706e67](https://user-images.githubusercontent.com/57765968/111067270-7be38500-84fe-11eb-9dbf-b887140aaea4.png)

应用层数据占用UDP报文段的`数据字段`。例如，对于DNS应用，数据字段要么包含一个查询报文，要么包含一个响应报文。对于流式音频应用，音频抽样数据填充到数据字段。

UDP首部只有4个字段，每个字段由两个字节组成。

通过`端口号`可以使目的主机将应用数据交给运行在目的端系统中的相应进程（即执行分解功能）。指示了在UDP报文段中的字节数（首部加数据）。

因为数据字段的`长度`在一个UDP段中 不同于在另一个段中，故需要一个明确的长度。

接收方使用`检验和`来检查在该报文段中是否出现了差错。实际上，计算检验和时，除了 UDP报文段以外还包括了 IP首部的一些字 段。但是我们忽略这些细节，以便能从整体上看问题。

那让我们来看看检验和吧！






### UDP检验和

UDP检验和提供了**差错检测功能**。这就是说，检验和用于确定当UDP报文段从源到 达目的地移动时，其中的比特是否发生了改变（例如，由于链路中的噪声干扰或者存储在 路由器中时引入问题）。发送方的UDP对报文段中的所有16比特字的和进行反码运算, 求和时遇到的任何溢出都被回卷。得到的结果被放在UDP报文段中的检验和字段。

![image-20201211224341973](https://zouyishan.oss-cn-beijing.aliyuncs.com/images/20201211224343.png)

注意到最后一次加法有溢出，它要被回卷。反码运算就是将所有的0换成1,所有的 1转换成0。因此,该和0100101011000010的反码运算结果是1011010100111101,这就变为了检验和。在接收方，全部的4个16比特字（包括检验和）加在一起。如果该分组中 没有引入差错，则显然在接收方处该和将是1111111111111111如果这些比特之一是0, 那么我们就知道该分组中已经出现了差错。 

